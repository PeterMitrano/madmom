import argparse
import csv
import glob
import os

from madmom.custom_processors import ImShowOutputProcessor, SaveOutputProcessor, LabelOutputProcessor
from madmom.features.tf_beats import TfRhythmicGroupingPreProcessor
from madmom.processors import process_single, IOProcessor


def main():
    """
    Takes in a file mapping samples to responses,
    and creates an npz file with the network inputs (filtered audio) and labels
    """
    parser = argparse.ArgumentParser()
    parser.add_argument('map_file')
    parser.add_argument('--fps', action='store', type=float, default=100, help='frames per second [default=100]')
    args = parser.parse_args()

    map_reader = csv.reader(open(args.map_file, 'r'))
    next(map_reader)  # skip header

    # iterate over each sample
    for row in map_reader:
        sample_path = os.path.join(os.path.dirname(args.map_file), row[0])
        responses_path = os.path.join(os.path.dirname(args.map_file), row[1], "*.csv")

        csv_files = glob.glob(responses_path, recursive=False)
        # iterate over each participant who responded to this sample
        all_responses_to_sample = []
        for csv_file in csv_files:
            csv_reader = csv.reader(open(csv_file, 'r'))
            # iterate over each trial in which the participant heard this sample
            participant_responses = []
            for trial in csv_reader:
                for response in trial:
                    # TODO: make sure the start times are 0
                    participant_responses.append(float(response))
            all_responses_to_sample.append(participant_responses)

        preprocessor = TfRhythmicGroupingPreProcessor()
        if not os.path.exists(sample_path):
            raise ValueError("Sample path {} does not exist.".format(sample_path))

        infile = open(sample_path, 'rb')
        outfile = 'data/dataset.npz'

        save_processor = SaveOutputProcessor()
        imshow_processor = ImShowOutputProcessor()
        label_processor = LabelOutputProcessor(all_responses_to_sample, args.fps)

        # create an IOProcessor
        processor = IOProcessor(preprocessor, label_processor)
        process_single(processor, infile, outfile, **vars(args))


if __name__ == '__main__':
    main()
